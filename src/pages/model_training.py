import streamlit as st


def page():
    st.title(":material/science: Процесс обучения модели")
    st.markdown("---")

    st.markdown(
        """
# Описание пайплайна обучения модели (Training Pipeline)

Данный документ описывает процесс обучения моделей машинного обучения для прогнозирования дохода клиентов, реализованный в скрипте `train.py`. Весь процесс разбит на последовательные этапы: от загрузки и очистки данных до обучения ансамбля моделей и сохранения результатов.

---

## 1. Инициализация и Загрузка данных
Скрипт начинается с импорта необходимых библиотек (`pandas`, `numpy`, `sklearn`, `xgboost`, `lightgbm`, `catboost`) и настройки окружения.

- **Загрузка данных**: Считываются тренировочный (`hackathon_income_train.csv`) и тестовый (`hackathon_income_test.csv`) наборы данных.
- **Параметры загрузки**: Используется разделитель `;`, десятичный разделитель `,`, кодировка `UTF-8`.

---

## 2. Предобработка данных (Data Preprocessing)
Функция `preprocess_data` выполняет комплексную очистку и подготовку данных.

### Основные шаги:
1. **Обработка весов и ID**: 
   - Сохраняются ID для формирования финального сабмишена.
   - Выделяются веса наблюдений (колонка `w`), если они присутствуют в тренировочных данных.
2. **Удаление лишнего**: 
   - Удаляются служебные колонки (например, `id`, `dt`).
   - Удаляются признаки, в которых пропущено более **70%** значений.
3. **Выравнивание признаков**:
   - В выборках оставляются только те признаки, которые присутствуют и в `train`, и в `test`.
4. **Обработка пропусков и кодирование**:
   - **Категориальные признаки**: Пропуски заполняются значением `missing`, затем применяется `LabelEncoder`.
   - **Числовые признаки**: Пропуски заполняются медианным значением (`SimpleImputer(strategy="median")`).
5. **Обработка выбросов**:
   - Применяется **винзоризация** (Winsorization) числовых признаков: значения ограничиваются 1-м и 99-м перцентилями для подавления экстремальных выбросов.

---

## 3. Генерация признаков (Feature Engineering)
Функция `create_features` создает новые синтетические признаки на основе бизнес-логики для улучшения качества модели.

**Создаваемые признаки:**
- `credit_debit_ratio`: Отношение кредитовых оборотов к дебетовым.
- `balance_to_turnover`: Доля остатков на счетах относительно оборотов.
- `products_per_age`: Интенсивность использования продуктов банка относительно возраста.
- `debt_to_income`: Отношение долговой нагрузки к зарплате (DTI proxy).
- `avg_transaction_amount`: Средний чек транзакции (агрегация по транзакционным колонкам).

---

## 4. Отбор признаков (Feature Selection)
Функция `select_features` отбирает наиболее значимые признаки, чтобы уменьшить размерность и убрать шум.

- **Метод**: Используется `RandomForestRegressor`.
- **Критерий**: `feature_importances_` (важность признаков в лесе).
- **Результат**: Оставляются топ-100 наиболее важных признаков.

---

## 5. Обучение моделей (Model Training)
Функция `train_models` обучает зоопарк моделей градиентного бустинга и случайного леса. Перед обучением данные масштабируются с помощью `StandardScaler`.

### Используемые алгоритмы:
1. **XGBoost**: 
   - `n_estimators=1000`, `learning_rate=0.05`, `max_depth=6`.
   - Ранняя остановка (early stopping) по метрике MAE.
2. **LightGBM**: 
   - Аналогичные параметры, высокая скорость обучения.
3. **CatBoost**: 
   - Работает с `depth=6`, встроенная обработка категорий (хотя они уже закодированы).
4. **Random Forest**:
   - `n_estimators=500`, `max_depth=10` (более простая модель для устойчивости).

### Оценка качества:
Для валидации используется отложенная выборка (20%). Метрики:
- **MAE** (Mean Absolute Error)
- **WMAE** (Weighted MAE) — основная метрика, учитывающая веса наблюдений.
- **RMSE**, **R²**, **MAPE**.
- Дополнительно считается качество в разрезе групп по уровню дохода.

---

## 6. Ансамблирование (Ensembling)
Функция `create_ensemble_and_predict` объединяет предсказания отдельных моделей для повышения точности и устойчивости.

### Стратегии ансамблирования:
1. **Mean**: Простое среднее арифметическое предсказаний всех моделей.
2. **Median**: Медиана предсказаний (устойчива к выбросам одной из моделей).
3. **Weighted Average**: Взвешенное среднее, где вес модели обратно пропорционален её ошибке MAE (лучшие модели получают больший вес).
"""
    )

    st.markdown("## Оценки предсказаний")
    st.image("predictions_comparison.png")

model_training = st.Page(
    page,
    title="3 Обучение модели",
    icon=":material/model_training:",
    url_path="model_training",
)
